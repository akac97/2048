function GameManager(a,b,c,d){this.size=a;this.inputManager=new b;this.storageManager=new d;this.actuator=new c;this.startTiles=2;this.inputManager.on("move",this.move.bind(this));this.inputManager.on("restart",this.restart.bind(this));this.inputManager.on("undoMove",this.undoMove.bind(this));this.inputManager.on("restartWithConfirmation",this.restartWithConfirmation.bind(this));this.inputManager.on("undoWithConfirmation",this.undoWithConfirmation.bind(this));this.inputManager.on("keepPlaying",this.keepPlaying.bind(this));this.setup()}GameManager.prototype.restart=function(){this.storageManager.clearGameState();this.actuator.continueGame();this.setup()};GameManager.prototype.undoMove=function(){this.actuator.continueGame();if(this.storageManager.getLengthOfGameStatesStack()>0){var a=this.storageManager.popGameState();if(a){this.grid=new Grid(a.grid.size,a.grid.cells);this.score=a.score;this.over=a.over;this.won=a.won;this.keepPlaying=a.keepPlaying}this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated(),keepPlaying:this.keepPlaying})}};GameManager.prototype.restartWithConfirmation=function(){this.actuator.promptRestart()};GameManager.prototype.undoWithConfirmation=function(){this.actuator.promptUndo()};GameManager.prototype.keepPlaying=function(){this.keepPlaying=true;this.actuator.continueGame();this.actuate()};GameManager.prototype.isGameTerminated=function(){return this.over||(this.won&&!this.keepPlaying)};GameManager.prototype.setup=function(){var a=this.storageManager.getGameState();if(a){this.grid=new Grid(a.grid.size,a.grid.cells);this.score=a.score;this.over=a.over;this.won=a.won;this.keepPlaying=a.keepPlaying}else{this.grid=new Grid(this.size);this.score=0;this.over=false;this.won=false;this.keepPlaying=false;this.addStartTiles()}this.actuate()};GameManager.prototype.addStartTiles=function(){for(var a=0;a<this.startTiles;a++){this.addRandomTile()}};GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var b=Math.random()<0.9?2:4;var a=new Tile(this.grid.randomAvailableCell(),b);this.grid.insertTile(a)}};GameManager.prototype.actuate=function(){if(this.storageManager.getBestScore()<this.score){this.storageManager.setBestScore(this.score)}if(this.over){this.storageManager.clearGameState()}else{this.storageManager.setGameState(this.serialize());this.storageManager.pushGameState(this.serialize())}this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated(),keepPlaying:this.keepPlaying})};GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}};GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(a,c,b){if(b){b.mergedFrom=null;b.savePosition()}})};GameManager.prototype.moveTile=function(b,a){this.grid.cells[b.x][b.y]=null;this.grid.cells[a.x][a.y]=b;b.updatePosition(a)};GameManager.prototype.move=function(g){var d=this;if(this.isGameTerminated()){return}var a,f;var b=this.getVector(g);var c=this.buildTraversals(b);var e=false;this.prepareTiles();c.x.forEach(function(h){c.y.forEach(function(l){a={x:h,y:l};f=d.grid.cellContent(a);if(f){var j=d.findFarthestPosition(a,b);var k=d.grid.cellContent(j.next);if(k&&k.value===f.value&&!k.mergedFrom){var i=new Tile(j.next,f.value*2);i.mergedFrom=[f,k];d.grid.insertTile(i);d.grid.removeTile(f);f.updatePosition(j.next);d.score+=i.value;if(i.value===2048){d.won=true}}else{d.moveTile(f,j.farthest)}if(!d.positionsEqual(a,f)){e=true}}})});if(e){this.addRandomTile();if(!this.movesAvailable()){this.over=true}this.actuate()}};GameManager.prototype.getVector=function(b){var a={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return a[b]};GameManager.prototype.buildTraversals=function(a){var b={x:[],y:[]};for(var c=0;c<this.size;c++){b.x.push(c);b.y.push(c)}if(a.x===1){b.x=b.x.reverse()}if(a.y===1){b.y=b.y.reverse()}return b};GameManager.prototype.findFarthestPosition=function(a,b){var c;do{c=a;a={x:c.x+b.x,y:c.y+b.y}}while(this.grid.withinBounds(a)&&this.grid.cellAvailable(a));return{farthest:c,next:a}};GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()};GameManager.prototype.tileMatchesAvailable=function(){var e=this;var f;for(var c=0;c<this.size;c++){for(var h=0;h<this.size;h++){f=this.grid.cellContent({x:c,y:h});if(f){for(var g=0;g<2;g++){var d=e.getVector(g);var b={x:c+d.x,y:h+d.y};var a=e.grid.cellContent(b);if(a&&a.value===f.value){return true}}}}}return false};GameManager.prototype.positionsEqual=function(b,a){return b.x===a.x&&b.y===a.y};
